@* Copyright 2014-2016, hbz. Licensed under the Eclipse Public License 1.0 *@

@(q: String, json: String, from: Int, size: Int, home: controllers.HomeController)

@import play.api.libs.json._

@links(buckets: Seq[JsValue], key: String) = {
	@for(bucket <- buckets; term = (bucket \ "key").as[String]; count = (bucket \ "doc_count").as[Int]) {
		@if(q.contains(key+":\""+term+"\"")){
		@home.label(term)
		<a href='@routes.HomeController.search()?from=@from&size=@size&q=@q.replace("AND "+key+":\""+term+"\"","").trim'>
		<span class="badge">Filter entfernen &otimes;</span>
		</a>
		} else {
		<a href='@routes.HomeController.search()?from=@from&size=@size&q=@q.trim+AND+@key:"@term"'>@home.label(term) (@count)</a>
		}<br/>
	}
}

@facet(queryMetadata: JsValue, key: String) = {
	@defining((key.replace('.','_'), (queryMetadata \ "aggregations" \ key \ "buckets").as[Seq[JsValue]])) { case (jsKey, buckets) =>
		@if(!buckets.isEmpty) {
		<h4>@key.split("\\.")(0).capitalize</h4>
		@links(buckets.take(5), key)
		@if(buckets.size>5){
			<a id='more-@jsKey-link' href="javascript:void(0);" onclick='document.getElementById("more-@jsKey").style.display = ""; document.getElementById("more-@jsKey-link").style.display = "none"; document.getElementById("less-@jsKey-link").style.display = "";'>
			&oplus;Alle
			</a>
			<div id='more-@jsKey' style="display: none;">
			@links(buckets.drop(5), key)
			</div>
			<a id='less-@jsKey-link' href="javascript:void(0);" onclick='document.getElementById("more-@jsKey").style.display = "none"; document.getElementById("less-@jsKey-link").style.display = "none"; document.getElementById("more-@jsKey-link").style.display = "";' style='display:none;'>
			&ominus;Weniger
			</a>
		}}
	}
}

@main("Digitalisierte Drucke") {
	<div>
		<p>
		<form action="@routes.HomeController.search()" method="GET">
			<input type="text" autocomplete="off" style="width: 500px;"
				placeholder='Sammlungen und Titel suchen' autofocus name="q"
				@if(q!=null && !q.isEmpty && q!="*" ) {value="@q"}>
			<button type="submit">Suchen</button>
		</form>
		</p>
	</div>
	<p> Zeige alle @defining(routes.HomeController.search(q="*", t="collection")) {url => <a href="@url">Sammlungen</a>},
			@defining(routes.HomeController.search(q="*", t="title-print")) {url => <a href="@url">gedruckte Titel</a>},
			@defining(routes.HomeController.search(q="*", t="title-digital")) { url => <a href="@url">digitalisierte Titel</a>. }
	</p>
	@defining((Json.parse(json)\"hits"\"hits").as[Seq[JsValue]]) { items =>
		@if(items.size > 1) {
			<p>
			@defining((Json.parse(json) \ "hits" \ "total").as[Int]) { totalResults =>
				Treffer: @(totalResults) |
				@if(from > 0){<a href='@routes.HomeController.search(q=q, from=from-size)'>&LeftArrow; Vorige</a>}
				@(from+1)&mdash;@(Math.min(totalResults, from+size))
				@if(totalResults > from+size){<a href='@routes.HomeController.search(q=q, from=from+size)'>Nächste &RightArrow;</a>}
			}
			</p>
			<div class="grid">
				<div>
					<dl>
					@for(item <- items;
					     id = (item \ "_source" \ "id").asOpt[String].getOrElse("--");
					     title = (item \ "_source" \ "title").asOpt[String].getOrElse(id);
					     fulltext = (item \ "_source" \ "fulltextOnline").asOpt[String].getOrElse("")) {
						<dt>@title</dt>
						<dd>
						@if(!fulltext.isEmpty){
						<a href='@id.replace("digitalisiertedrucke.de", request().host())'>Details</a>, 
						<a href='@fulltext'>Volltext</a>
						| <a title="Korrekten Volltext-Link melden" href='mailto:lobid-admin@@hbz-nrw.de?subject=Korrekter Volltext-Link für @id'>&#x270e;</a>
						} else {
							<a href='@id.replace("digitalisiertedrucke.de", request().host())'>@id</a>
						}
						</dd>
					}
					</dl>
				</div>
				<div>
					@for(field <- HomeController.FACETS) {
						@facet(Json.parse(json), field)
					}
				</div>
		</div>
		} else {
			@if(!q.trim.isEmpty){<p>Keine Treffer.</p>}
		}
	}
}